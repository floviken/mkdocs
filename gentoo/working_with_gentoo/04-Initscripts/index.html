
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://floviken.github.io/mkdocs/gentoo/working_with_gentoo/04-Initscripts/">
      
      
        <link rel="prev" href="../03-Features/">
      
      
        <link rel="next" href="../05-EnvVar/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.1, mkdocs-material-9.1.21">
    
    
      
        <title>Runlevels - KaboliDocs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Runlevels - KaboliDocs" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://floviken.github.io/mkdocs/assets/images/social/gentoo/working_with_gentoo/04-Initscripts.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://floviken.github.io/mkdocs/gentoo/working_with_gentoo/04-Initscripts/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Runlevels - KaboliDocs" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://floviken.github.io/mkdocs/assets/images/social/gentoo/working_with_gentoo/04-Initscripts.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#runlevels" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="KaboliDocs" class="md-header__button md-logo" aria-label="KaboliDocs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            KaboliDocs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Runlevels
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Welcome to MkDocs
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../ssh/" class="md-tabs__link">
      SSH setup
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link md-tabs__link--active">
        Gentoo
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="KaboliDocs" class="md-nav__button md-logo" aria-label="KaboliDocs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    KaboliDocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../ssh/" class="md-nav__link">
        SSH setup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Gentoo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Gentoo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        gentoo handbook
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/01-About%20the%20Gentoo%20Linux%20Installation/" class="md-nav__link">
        About the Gentoo Linux Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/010-Configuring%20the%20bootloader/" class="md-nav__link">
        Configuring the bootloader
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/02-Choosing%20the%20right%20installation%20medium/" class="md-nav__link">
        Choosing the right installation medium
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/03-Configuring%20the%20network/" class="md-nav__link">
        Configuring the network
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/04-Preparing%20the%20disks/" class="md-nav__link">
        Preparing the disks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/05-Installing%20the%20Gentoo%20installation%20files/" class="md-nav__link">
        Installing the Gentoo installation files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/06-Installing%20the%20Gentoo%20base%20system/" class="md-nav__link">
        Installing the Gentoo base system
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/07-Configuring%20the%20linux%20kernel/" class="md-nav__link">
        Configuring the Linux kernel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/08-Configuring%20the%20system/" class="md-nav__link">
        Configuring the system
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/09-Installing%20system%20tools/" class="md-nav__link">
        Installing system tools
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          Working with gentoo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Working with gentoo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-Portage/" class="md-nav__link">
        Working with Gentoo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../02-Use/" class="md-nav__link">
        What are USE flags
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../03-Features/" class="md-nav__link">
        Portage features
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Runlevels
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Runlevels
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#runlevels_1" class="md-nav__link">
    Runlevels
  </a>
  
    <nav class="md-nav" aria-label="Runlevels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#booting-the-system" class="md-nav__link">
    Booting the system
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-init-works" class="md-nav__link">
    How init works
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#available-runlevels" class="md-nav__link">
    Available runlevels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#working-with-initscripts" class="md-nav__link">
    Working with initscripts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-runlevels" class="md-nav__link">
    Updating runlevels
  </a>
  
    <nav class="md-nav" aria-label="Updating runlevels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rc-update" class="md-nav__link">
    rc-update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-and-removing-services" class="md-nav__link">
    Adding and removing services
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-services" class="md-nav__link">
    Configuring services
  </a>
  
    <nav class="md-nav" aria-label="Configuring services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-additional-configuration-is-needed" class="md-nav__link">
    Why additional configuration is needed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confd-directory" class="md-nav__link">
    conf.d directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-initscripts" class="md-nav__link">
    Writing initscripts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is-it-necessary" class="md-nav__link">
    Is it necessary?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layout" class="md-nav__link">
    Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlling-the-order" class="md-nav__link">
    Controlling the order
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#standard-functions" class="md-nav__link">
    Standard functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-configuration-variables" class="md-nav__link">
    Service configuration variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changing-runlevel-behavior" class="md-nav__link">
    Changing runlevel behavior
  </a>
  
    <nav class="md-nav" aria-label="Changing runlevel behavior">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#who-might-benefit" class="md-nav__link">
    Who might benefit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-softlevel" class="md-nav__link">
    Using softlevel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-bootlevel" class="md-nav__link">
    Using bootlevel
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05-EnvVar/" class="md-nav__link">
        Environment variables
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
      
      
      
        <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
          Working with portage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Working with portage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../working_with_portage/01-Files/" class="md-nav__link">
        01 Files
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="runlevels">Runlevels</h1>
<h2 id="runlevels_1">Runlevels</h2>
<h3 id="booting-the-system">Booting the system</h3>
<p>When the system is booted, lots of text floats by. When paying close attention, one will notice this text is (usually) the same every time the system is rebooted. The sequence of all these actions is called the boot sequence and is (more or less) statically defined.</p>
<p>First, the boot loader will load the kernel image that is defined in the boot loader configuration. Then, the boot loader instructs the CPU to execute kernel. When the kernel is loaded and run, it initializes all kernel-specific structures and tasks and starts the init process.</p>
<p>This process then makes sure that all filesystems (defined in /etc/fstab) are mounted and ready to be used. Then it executes several scripts located in /etc/init.d/, which will start the services needed in order to have a successfully booted system.</p>
<p>Finally, when all scripts are executed, init activates the terminals (in most cases just the virtual consoles which are hidden beneath <code>Alt+F1</code>, <code>Alt+F2</code>, etc.) attaching a special process called agetty to it. This process will then make sure users are able to log on through these terminals by running login.</p>
<p>Initscripts
Now init doesn't just execute the scripts in /etc/init.d/ randomly. Even more, it doesn't run all scripts in /etc/init.d/, only the scripts it is told to execute. It decides which scripts to execute by looking into /etc/runlevels/.</p>
<p>First, init runs all scripts from /etc/init.d/ that have symbolic links inside /etc/runlevels/boot/. Usually, it will start the scripts in alphabetical order, but some scripts have dependency information in them, telling the system that another script must be run before they can be started.</p>
<p>When all /etc/runlevels/boot/ referenced scripts are executed, init continues with running the scripts that have a symbolic link to them in /etc/runlevels/default/. Again, it will use the alphabetical order to decide what script to run first, unless a script has dependency information in it, in which case the order is changed to provide a valid start-up sequence. The latter is also the reason why commands used during the installation of Gentoo Linux used <code>default</code>, as in <strong>rc-update add sshd default</strong>.</p>
<h3 id="how-init-works">How init works</h3>
<p>Of course init doesn't decide all that by itself. It needs a configuration file that specifies what actions need to be taken. This configuration file is /etc/inittab.</p>
<p>Remember the boot sequence that was just described - init's first action is to mount all file systems. This is defined in the following line from /etc/inittab:</p>
<div class="highlight"><span class="filename">FILE /etc/inittabInitialization command</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>si::sysinit:/sbin/openrc<span class="w"> </span>sysinit
</code></pre></div>
<p>This line tells init that it must run <strong>/sbin/openrc sysinit</strong> to initialize the system. The /sbin/openrc script takes care of the initialization, so one might say that init doesn't do much - it delegates the task of initializing the system to another process.</p>
<p>Second, init executed all scripts that had symbolic links in /etc/runlevels/boot/. This is defined in the following line:</p>
<div class="highlight"><span class="filename">FILE /etc/inittabBoot command invocation</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>rc::bootwait:/sbin/openrc<span class="w"> </span>boot
</code></pre></div>
<p>Again the openrc script performs the necessary tasks. Note that the option given to openrc (boot) is the same as the subdirectory of /etc/runlevels/ that is used.</p>
<p>Now init checks its configuration file to see what runlevel it should run. To decide this, it reads the following line from /etc/inittab:</p>
<div class="highlight"><span class="filename">FILE /etc/inittabDefault runlevel selection</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>id:3:initdefault:
</code></pre></div>
<p>In this case (which the majority of Gentoo users will use), the runlevel id is 3. Using this information, init checks what it must run to start runlevel 3:</p>
<div class="highlight"><span class="filename">FILE /etc/inittabRunlevel definitions</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>l0:0:wait:/sbin/openrc<span class="w"> </span>shutdown
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>l1:S1:wait:/sbin/openrc<span class="w"> </span>single
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>l2:2:wait:/sbin/openrc<span class="w"> </span>nonetwork
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>l3:3:wait:/sbin/openrc<span class="w"> </span>default
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>l4:4:wait:/sbin/openrc<span class="w"> </span>default
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>l5:5:wait:/sbin/openrc<span class="w"> </span>default
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>l6:6:wait:/sbin/openrc<span class="w"> </span>reboot
</code></pre></div>
<p>The line that defines level 3, again, uses the openrc script to start the services (now with argument <code>default</code>). Again note that the argument of openrc is the same as the subdirectory from /etc/runlevels/.</p>
<p>When openrc has finished, init decides what virtual consoles it should activate and what commands need to be run at each console:</p>
<div class="highlight"><span class="filename">FILE /etc/inittabTerminal definitions</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>c1:12345:respawn:/sbin/agetty<span class="w"> </span><span class="m">38400</span><span class="w"> </span>tty1<span class="w"> </span>linux
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>c2:12345:respawn:/sbin/agetty<span class="w"> </span><span class="m">38400</span><span class="w"> </span>tty2<span class="w"> </span>linux
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>c3:12345:respawn:/sbin/agetty<span class="w"> </span><span class="m">38400</span><span class="w"> </span>tty3<span class="w"> </span>linux
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>c4:12345:respawn:/sbin/agetty<span class="w"> </span><span class="m">38400</span><span class="w"> </span>tty4<span class="w"> </span>linux
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>c5:12345:respawn:/sbin/agetty<span class="w"> </span><span class="m">38400</span><span class="w"> </span>tty5<span class="w"> </span>linux
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>c6:12345:respawn:/sbin/agetty<span class="w"> </span><span class="m">38400</span><span class="w"> </span>tty6<span class="w"> </span>linux
</code></pre></div>
<h3 id="available-runlevels">Available runlevels</h3>
<p>In a previous section, we saw that init uses a numbering scheme to decide what runlevel it should activate. A runlevel is a state in which the system is running and contains a collection of scripts (runlevel scripts or initscripts) that must be executed when entering or leaving a runlevel.</p>
<p>In Gentoo, there are seven runlevels defined: three internal runlevels, and four user-defined runlevels. The internal runlevels are called sysinit, shutdown and reboot and do exactly what their names imply: initialize the system, powering off the system, and rebooting the system.</p>
<p>The user-defined runlevels are those with an accompanying /etc/runlevels/ subdirectory: boot, default, nonetwork and single. The boot runlevel starts all system-necessary services which all other runlevels use. The remaining three runlevels differ in what services they start: default is used for day-to-day operations, nonetwork is used in case no network connectivity is required, and single is used when the system needs to be fixed.</p>
<h3 id="working-with-initscripts">Working with initscripts</h3>
<p>The scripts that the openrc process starts are called init scripts. Each script in /etc/init.d/ can be executed with the arguments <code>start</code>, <code>stop</code>, <code>restart</code>, <code>zap</code>, <code>status</code>, <code>ineed</code>, <code>iuse</code>, <code>iwant</code>, <code>needsme</code>, <code>usesme</code>, or wantsme.</p>
<p>To start, stop, or restart a service (and all depending services), the <code>start</code>, <code>stop</code>, and <code>restart</code> arguments should be used:</p>
<p><code>root # rc-service postfix start</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Only the services that need the given service are stopped or restarted. 
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>The other depending services (those that use the service but don&#39;t need it) 
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>are left untouched.
</code></pre></div>
<p>To stop a service, but not the services that depend on it, use the <code>--nodeps</code> option together with the <code>stop</code> argument:</p>
<p><code>root # rc-service --nodeps postfix stop</code></p>
<p>To see what status a service has (started, stopped, ...) use the <code>status</code> argument:</p>
<p><code>root # rc-service postfix status</code></p>
<p>If the status information shows that the service is running, but in reality it is not, then reset the status information to "stopped" with the <code>zap</code> argument:</p>
<p><code>root # rc-service postfix zap</code></p>
<p>To also ask what dependencies the service has, use <code>iwant</code>, <code>iuse</code> or <code>ineed</code>. With <code>ineed</code> it is possible to see the services that are really necessary for the correct functioning of the service. <code>iwant</code> or <code>iuse</code>, on the other hand, shows the services that can be used by the service, but are not necessary for the correct functioning.</p>
<p><code>root # rc-service postfix ineed</code></p>
<p>Similarly, it is possible to ask what services require the service (<code>needsme</code>) or can use it (<code>usesme</code> or <code>wantsme</code>):</p>
<p><code>root # rc-service postfix needsme</code></p>
<h2 id="updating-runlevels">Updating runlevels</h2>
<h3 id="rc-update">rc-update</h3>
<p>Gentoo's init system uses a dependency-tree to decide what service needs to be started first. As this is a tedious task that we wouldn't want our users to have to do manually, we have created tools that ease the administration of the runlevels and init scripts.</p>
<p>With <strong>rc-update</strong> it is possible to add and remove init scripts to a runlevel. The <strong>rc-update</strong> tool will then automatically ask the depscan.sh script to rebuild the dependency tree.</p>
<h3 id="adding-and-removing-services">Adding and removing services</h3>
<p>In earlier instructions, init scripts have already been added to the "default" runlevel. What "default" means has been explained earlier in this document. Next to the runlevel, the <strong>rc-update</strong> script requires a second argument that defines the action: <code>add</code>, <code>del</code>, or <code>show</code>.</p>
<p>To add or remove an init script, just give <strong>rc-update</strong> the add or del argument, followed by the init script and the runlevel. For instance:</p>
<p><code>root # rc-update del postfix default</code></p>
<p>The <strong>rc-update -v show</strong> command will show all the available init scripts and list at which runlevels they will execute:</p>
<p><code>root # rc-update -v show</code></p>
<p>It is also possible to run <strong>rc-update show</strong> (without -v) to just view enabled init scripts and their runlevels.</p>
<h2 id="configuring-services">Configuring services</h2>
<h3 id="why-additional-configuration-is-needed">Why additional configuration is needed</h3>
<p>Init scripts can be quite complex. It is therefore not really desirable to have the users edit the init script directly, as it would make it more error-prone. It is however important to be able to configure such a service. For instance, users might want to give more options to the service itself.</p>
<p>A second reason to have this configuration outside the init script is to be able to update the init scripts without the fear that the user's configuration changes will be undone.</p>
<h3 id="confd-directory">conf.d directory</h3>
<p>Gentoo provides an easy way to configure such a service: every init script that can be configured has a file in /etc/conf.d/. For instance, the apache2 initscript (called /etc/init.d/apache2) has a configuration file called /etc/conf.d/apache2, which can contain the options to give to the Apache 2 server when it is started:</p>
<div class="highlight"><span class="filename">FILE /etc/conf.d/apache2Example options for apache2 init script</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nv">APACHE2_OPTS</span><span class="o">=</span><span class="s2">&quot;-D PHP5&quot;</span>
</code></pre></div>
<p>Such a configuration file contains only variables (just like /etc/portage/make.conf does), making it very easy to configure services. It also allows us to provide more information about the variables (as comments).</p>
<h3 id="writing-initscripts">Writing initscripts</h3>
<p>Another useful resource is OpenRC's <a href="https://github.com/OpenRC/openrc/blob/master/service-script-guide.md">service script guide</a>.</p>
<h3 id="is-it-necessary">Is it necessary?</h3>
<p>No, writing an init script is usually not necessary as Gentoo provides ready-to-use init scripts for all provided services. However, some users might have installed a service without using Portage, in which case they will most likely have to create an init script.</p>
<p>Do not use the init script provided by the service if it isn't explicitly written for Gentoo: Gentoo's init scripts are not compatible with the init scripts used by other distributions! That is, unless the other distribution is using <a href="https://wiki.gentoo.org/wiki/OpenRC">OpenRC</a>!</p>
<h3 id="layout">Layout</h3>
<p>The basic layout of an init script is shown below.</p>
<div class="highlight"><span class="filename">CODE Example initscript layout (traditional)</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="ch">#!/sbin/openrc-run</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1">#  (Dependency information)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="o">}</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>start<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c1">#  (Commands necessary to start the service)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="o">}</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>stop<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="c1">#  (Commands necessary to stop the service)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="o">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">CODE Example initscript layout (updated)</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="ch">#!/sbin/openrc-run</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nv">command</span><span class="o">=</span>/usr/bin/foo
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="nv">command_args</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">foo_args</span><span class="si">}</span><span class="s2"> --bar&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="nv">pidfile</span><span class="o">=</span>/var/run/foo.pid
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="nv">name</span><span class="o">=</span><span class="s2">&quot;FooBar Daemon&quot;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="nv">description</span><span class="o">=</span><span class="s2">&quot;FooBar is a daemon that drinks&quot;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="nv">extra_started_commands</span><span class="o">=</span><span class="s2">&quot;drink&quot;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="nv">description_drink</span><span class="o">=</span><span class="s2">&quot;Opens mouth and reflexively swallows&quot;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="c1">#  (Dependency information)</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="o">}</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>start_pre<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="c1">#  (Commands necessary to prepare to start the service)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="c1"># Ensure that our dirs are correct</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">    </span>checkpath<span class="w"> </span>--directory<span class="w"> </span>--owner<span class="w"> </span>foo:foo<span class="w"> </span>--mode<span class="w"> </span><span class="m">0775</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">        </span>/var/run/foo<span class="w"> </span>/var/cache/foo
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="o">}</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>stop_post<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="c1">#  (Commands necessary to clean up after the service)</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">    </span><span class="c1"># Clean any spills</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/cache/foo/*
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="o">}</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>drink<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">    </span>ebegin<span class="w"> </span><span class="s2">&quot;Starting to drink&quot;</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">    </span><span class="si">${</span><span class="nv">command</span><span class="si">}</span><span class="w"> </span>--drink<span class="w"> </span>beer
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">    </span>eend<span class="w"> </span><span class="nv">$?</span><span class="w"> </span><span class="s2">&quot;Failed to drink any beer :(&quot;</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="o">}</span>
</code></pre></div>
<p>Every init script requires the <code>start()</code> function or <code>command</code> variable to be defined. All other sections are optional.</p>
<h3 id="dependencies">Dependencies</h3>
<p>There are three dependency-alike settings that can be defined which influence the start-up or sequencing of init scripts: <code>want</code>, <code>use</code> and <code>need</code>. Next to these, there are also two order-influencing methods called <code>before</code> and <code>after</code>. These last two are no dependencies per se - they do not make the original init script fail if the selected one isn't scheduled to start (or fails to start).</p>
<ul>
<li>
<p>The <code>use</code> settings informs the init system that this script uses functionality offered by the selected script, but does not directly depend on it. A good example would be <code>use logger</code> or <code>use dns</code>. If those services are available, they will be put in good use, but if the system does not have a logger or DNS server the services will still work. If the services exist, then they are started before the script that uses them.</p>
</li>
<li>
<p>The <code>want</code> setting is similar to <code>use</code> with one exception. <code>use</code> only considers services which were added to an init level. <code>want</code> will try to start any available service even if not added to an init level.</p>
</li>
<li>
<p>The <code>need</code> setting is a hard dependency. It means that the script that is needing another script will not start before the other script is launched successfully. Also, if that other script is restarted, then this one will be restarted as well.</p>
</li>
<li>
<p>When using <code>before</code>, then the given script is launched before the selected one if the selected one is part of the init level. So an init script xdm that defines <code>before alsasound</code> will start before the alsasound script, but only if alsasound is scheduled to start as well in the same init level. If alsasound is not scheduled to start too, then this particular setting has no effect and xdm will be started when the init system deems it most appropriate.</p>
</li>
<li>
<p>Similarly, <code>after</code> informs the init system that the given script should be launched after the selected one if the selected one is part of the init level. If not, then the setting has no effect and the script will be launched by the init system when it deems it most appropriate.</p>
</li>
</ul>
<p>It should be clear from the above that <code>need</code> is the only "true" dependency setting as it affects if the script will be started or not. All the others are merely pointers towards the init system to clarify in which order scripts can be (or should be) launched.</p>
<p>Now, look at many of Gentoo's available init scripts and notice that some have dependencies on things that are no init scripts. These "things" we call virtuals.</p>
<p>A <em>virtual dependency</em> is a dependency that a service provides, but that is not provided solely by that service. An init script can depend on a system logger, but there are many system loggers available (metalogd, syslog-ng, sysklogd, ...). As the script cannot need every single one of them (no sensible system has all these system loggers installed and running) we made sure that all these services provide a virtual dependency.</p>
<p>For instance, take a look at the postfix dependency information:</p>
<div class="highlight"><span class="filename">FILE /etc/init.d/postfixDependency information of the postfix service</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">  </span>need<span class="w"> </span>net
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span>use<span class="w"> </span>logger<span class="w"> </span>dns
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span>provide<span class="w"> </span>mta
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="o">}</span>
</code></pre></div>
<p>As can be seen, the postfix service:</p>
<ul>
<li>Requires the (virtual) net dependency (which is provided by, for instance, /etc/init.d/net.eth0).</li>
<li>Uses the (virtual) logger dependency (which is provided by, for instance, /etc/init.d/syslog-ng).</li>
<li>Uses the (virtual) dns dependency (which is provided by, for instance, /etc/init.d/named).</li>
<li>Provides the (virtual) mta dependency (which is common for all mail servers).</li>
</ul>
<h3 id="controlling-the-order">Controlling the order</h3>
<p>As described in the previous section, it is possible to tell the init system what order it should use for starting (or stopping) scripts. This ordering is handled both through the dependency settings use and need, but also through the order settings before and after. As we have described these earlier already, let's take a look at the portmap service as an example of such init script.</p>
<p><div class="highlight"><span class="filename">FILE /etc/init.d/portmapDependency information of the portmap service</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span>need<span class="w"> </span>net
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span>before<span class="w"> </span>inetd
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span>before<span class="w"> </span>xinetd
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="o">}</span>
</code></pre></div>
It is possible to use the "*" glob to catch all services in the same runlevel, although this isn't advisable.</p>
<div class="highlight"><span class="filename">CODE Using the * glob</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span>before<span class="w"> </span>*
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="o">}</span>
</code></pre></div>
<p>If the service must write to local disks, it should need localmount. If it places anything in /var/run/ such as a pidfile, then it should start after bootmisc:</p>
<div class="highlight"><span class="filename">CODE Dependency setting with needing localmount and after bootmisc</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>depend<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span>need<span class="w"> </span>localmount
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span>after<span class="w"> </span>bootmisc
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="o">}</span>
</code></pre></div>
<h3 id="standard-functions">Standard functions</h3>
<p>Next to the <code>depend()</code> functionality, it is also necessary to define the <code>start()</code> function. This one contains all the commands necessary to initialize the service. It is advisable to use the <code>ebegin</code> and <code>eend</code> functions to inform the user about what is happening:</p>
<div class="highlight"><span class="filename">CODE Example start() function</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>start<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">RC_CMD</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;restart&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="k">then</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="c1"># Do something in case a restart requires more than stop, start</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="k">fi</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span>ebegin<span class="w"> </span><span class="s2">&quot;Starting my_service&quot;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span>start-stop-daemon<span class="w"> </span>--start<span class="w"> </span>--exec<span class="w"> </span>/path/to/my_service<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span>--pidfile<span class="w"> </span>/path/to/my_pidfile
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">  </span>eend<span class="w"> </span><span class="nv">$?</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="o">}</span>
</code></pre></div>
<p>Both <code>--exec</code> and <code>--pidfile</code> should be used in start and stop functions. If the service does not create a pidfile, then use <code>--make-pidfile</code> if possible, though it is recommended to test this to be sure. Otherwise, don't use pidfiles. It is also possible to add <code>--quiet</code> to the start-stop-daemon options, but this is not recommended unless the service is extremely verbose. Using <code>--quiet</code> may hinder debugging if the service fails to start.</p>
<p>Another notable setting used in the above example is to check the contents of the <em>RC_CMD</em> variable. Unlike the previous init script system, the newer OpenRC system does not support script-specific restart functionality. Instead, the script needs to check the contents of the <em>RC_CMD</em> variable to see if a function (be it <code>start()</code> or <code>stop()</code>) is called as part of a restart or not.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>Make sure that `--exec` actually calls a service and not just a shell script that launches services and exits - that&#39;s what the init script is supposed to do.
</code></pre></div>
<p>For more examples of the <code>start()</code> function, please read the source code of the available init scripts in the /etc/init.d/ directory.</p>
<p>Another function that can (but does not have to) be defined is <code>stop()</code>. The init system is intelligent enough to fill in this function by itself if start-stop-daemon is used.</p>
<div class="highlight"><span class="filename">CODE Example stop() function</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>stop<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">  </span>ebegin<span class="w"> </span><span class="s2">&quot;Stopping my_service&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">  </span>start-stop-daemon<span class="w"> </span>--stop<span class="w"> </span>--exec<span class="w"> </span>/path/to/my_service<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span>--pidfile<span class="w"> </span>/path/to/my_pidfile
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">  </span>eend<span class="w"> </span><span class="nv">$?</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="o">}</span>
</code></pre></div>
<p>If the service runs some other script (for example, Bash, Python, or Perl), and this script later changes names (for example, foo.py to foo), then it is necessary to add <code>--name</code> to start-stop-daemon. This must specify the name that the script will be changed to. In this example, a service starts foo.py, which changes names to foo:</p>
<p>```sh title=""CODE Example definition for a service that starts the foo script"
start() {
  ebegin "Starting my_script"
  start-stop-daemon --start --exec /path/to/my_script \
    --pidfile /path/to/my_pidfile --name foo
  eend $?
}
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>start-stop-daemon has an excellent man page available if more information is needed:
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>`user $ man start-stop-daemon`
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>Gentoo&#39;s init script syntax is based on the POSIX Shell so people are free to use sh-compatible constructs inside their init scripts. Keep other constructs, like bash-specific ones, out of the init scripts to ensure that the scripts remain functional regardless of the change Gentoo might do on its init system.
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>### Adding custom options
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>If the initscript needs to support more options than the ones we have already encountered, then add the option to one of the following variables, and create a function with the same name as the option. For instance, to support an option called `restartdelay`:
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>- *extra_commands* - Command is available with the service in any state
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>- *extra_started_commands* - Command is available when the service is started
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>- *extra_stopped_commands* - Command is available when the service is stopped
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>```sh title=&quot;CODE Example definition of restartdelay method&quot;
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>extra_started_commands=&quot;restartdelay&quot;
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>restartdelay() {
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>  stop
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>  sleep 3    # Wait 3 seconds before starting again
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>  start
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>}
</code></pre></div></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
</div>
<p>The <code>restart()</code> function cannot be overridden in OpenRC!</p>
<h3 id="service-configuration-variables">Service configuration variables</h3>
<p>In order to support configuration files in /etc/conf.d/, no specifics need to be implemented: when the init script is executed, the following files are automatically sourced (i.e. the variables are available to use):</p>
<ul>
<li>/etc/conf.d/YOUR_INIT_SCRIPT</li>
<li>/etc/conf.d/basic</li>
<li>/etc/rc.conf</li>
</ul>
<p>Also, if the init script provides a virtual dependency (such as net), the file associated with that dependency (such as /etc/conf.d/net) will be sourced too.</p>
<h2 id="changing-runlevel-behavior">Changing runlevel behavior</h2>
<h3 id="who-might-benefit">Who might benefit</h3>
<p>Many laptop users know the situation: at home they need to start net.eth0, but they don't want to start net.eth0 while on the road (as there is no network available). With Gentoo the runlevel behaviour can be altered at will.</p>
<p>For instance, a second "default" runlevel can be created which can be booted that has other init scripts assigned to it. At boottime, the user can then select what default runlevel to use.</p>
<h3 id="using-softlevel">Using softlevel</h3>
<p>First of all, create the runlevel directory for the second "default" runlevel. As an example we create the <em>offline</em> runlevel:</p>
<p><code>root # mkdir /etc/runlevels/offline</code></p>
<p>Add the necessary init scripts to the newly created runlevel. For instance, to have an exact copy of the current default runlevel but without net.eth0:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>root # cd /etc/runlevels/default
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>root # for service in *; do rc-update add $service offline; done
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>root # rc-update del net.eth0 offline
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>root # rc-update show offline
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>(Partial sample Output)
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>               acpid | offline
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>          domainname | offline
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>               local | offline
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>            net.eth0 |
</code></pre></div>
<p>Even though net.eth0 has been removed from the offline runlevel, udev might want to attempt to start any devices it detects and launch the appropriate services, a functionality that is called hotplugging. By default, Gentoo does not enable hotplugging.</p>
<p>To enable hotplugging, but only for a selected set of scripts, use the <em>rc_hotplug</em> variable in /etc/rc.conf:</p>
<p><code>sh title=""FILE /etc/rc.confEnable hotplugging of the WLAN interface"
rc_hotplug="net.wlan !net.*"
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>!!! Note
</code></pre></div>
For more information on device initiated services, please see the comments inside /etc/rc.conf.
Edit the bootloader configuration and add a new entry for the offline runlevel. In that entry, add softlevel=offline as a boot parameter.</code></p>
<h3 id="using-bootlevel">Using bootlevel</h3>
<p>Using bootlevel is completely analogous to softlevel. The only difference here is that a second "boot" runlevel is defined instead of a second "default" runlevel.</p>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 <a href="https://github.com/floviken"  target="_blank" rel="noopener">kaboli</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/floviken" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.sections", "navigation.sections", "navigation.expand", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>